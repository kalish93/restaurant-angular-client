<div class="lg:col-span-1" *ngIf="cart.length > 0">
  <mat-card class="sticky xl:top-4 rounded-xl shadow-lg">
    <div class="bg-stone-600 text-white p-4 min-h-[50px] rounded-t-xl">
      <div class="flex items-center justify-between">
        <h3 class="!text-[16px] font-semibold text-white">Order Summary</h3>
        <span class="text-sm text-white/80">
          {{ getTotalItems() }} items
        </span>
      </div>
    </div>

    <mat-card-content class="p-4 space-y-4">
      <div class="space-y-3 pt-8">
        <div *ngFor="let item of cart; let i = index"
          class="group relative flex flex-col p-3 rounded-lg border border-orange-200 hover:border-orange-300 transition-colors duration-200"
          [class.expanding]="showInstructionsFor[item.menuItem.id]">

          <!-- Remove Item -->
          <button (click)="removeFromCart(item)" variant="icon"
            class="absolute top-[9px] right-2 text-gray-700 hover:text-red-500 transition-all duration-200 z-10"
            [attr.aria-label]="'Remove ' + item.menuItem.name">
            <mat-icon class="!text-base !w-[16px] !h-[16px]">close</mat-icon>
          </button>

          <!-- Item Details -->
          <div class="flex justify-between items-start pr-8 mb-3">
            <div class="flex-1">
              <p class="text-sm font-medium text-gray-900">{{ item.menuItem.name }}</p>
              <p class="text-xs text-gray-700">{{ item.menuItem.price.toFixed(2) }} ETB each</p>
            </div>
            <div class="text-right">
              <p class="text-sm font-medium text-gray-900">
                ETB {{ (item.menuItem.price * item.quantity).toFixed(2) }}
              </p>
            </div>
          </div>

          <!-- Quantity + Special Instructions -->
          <div class="flex items-center justify-between">
            <div class="flex items-center gap-2">
              <span class="text-xs text-gray-700">Qty:</span>

              <!-- Decrease Button -->
              <button mat-icon-button
                (click)="updateQuantity(i, item.quantity - 1)"
                [disabled]="item.quantity <= 1"
                class="hover:text-orange-700 disabled:opacity-50 disabled:cursor-not-allowed"
                aria-label="Decrease quantity">
                <mat-icon class="!text-[20px]">remove</mat-icon>
              </button>

              <!-- Quantity Number -->
              <span class="text-sm font-medium text-gray-900 w-[24px] text-center">
                {{ item.quantity }}
              </span>

              <!-- Increase Button -->
              <button mat-icon-button
                (click)="updateQuantity(i, item.quantity + 1)"
                class="hover:text-orange-700"
                aria-label="Increase quantity">
                <mat-icon class="!text-[20px]">add</mat-icon>
              </button>
            </div>

            <!-- Special Instructions Toggle -->
            <button (click)="toggleSpecialInstructions(item.menuItem.id)"
              class="text-xs text-orange-600 hover:text-orange-700 font-medium transition-colors flex items-center gap-1 mb-1">
              <mat-icon class="!text-xs !h-[14px] !w-[14px]">
                {{ showInstructionsFor[item.menuItem.id] ? 'remove' : (item.specialInstructions ? 'edit' : 'add') }}
              </mat-icon>
              {{ showInstructionsFor[item.menuItem.id] ? 'Remove' : (item.specialInstructions ? 'Edit' : 'Add') }}
              Special Instructions
            </button>
          </div>

          <!-- Special Instructions Textarea -->
          <div *ngIf="showInstructionsFor[item.menuItem.id]" class="rounded-lg mb-2">
            <mat-form-field appearance="outline" class="w-full !h-[100px]">
              <mat-label>Special instructions</mat-label>
              <textarea matInput class="!h-[100px]" cdkTextareaAutosize cdkAutosizeMinRows="4"
                placeholder="e.g., No onions, extra spicy..."
                [value]="specialInstructions[item.menuItem.id] || ''"
                (input)="updateSpecialInstructions(item.menuItem.id, $any($event.target).value)"
                class="resize-none text-xs"></textarea>
            </mat-form-field>
          </div>

          <!-- Display Special Instructions -->
          <div *ngIf="item.specialInstructions" class="mt-3 p-2 rounded-md bg-orange-50 border border-orange-200">
            <div class="flex items-center gap-2">
              <span class="text-xs font-medium text-orange-800 shrink-0">Note:</span>
              <p class="text-xs text-orange-700 leading-relaxed">
                {{ item.specialInstructions }}
              </p>
            </div>
          </div>
        </div>
      </div>

      <!-- Subtotal -->
      <div class="space-y-3 pt-4 border-t border-orange-200">
        <div class="flex justify-between text-sm pb-2 border-b border-orange-200">
          <span class="text-gray-700">Subtotal</span>
          <span class="font-medium text-gray-900">ETB {{ getSubtotal().toFixed(2) }}</span>
        </div>
      </div>

      <!-- Total & Order Button -->
      <div (click)="order()" class="bg-orange-400 hover:bg-orange-500 cursor-pointer text-white p-4 rounded-lg">
        <div class="flex justify-between items-center">
          <span class="text-lg font-semibold">Total to pay</span>
          <span class="text-2xl font-bold">ETB {{ getTotal().toFixed(2) }}</span>
        </div>
      </div>

      <button mat-flat-button
        class="w-full bg-green-600 hover:bg-green-700 text-white py-3 text-lg font-semibold rounded-lg"
        (click)="order()">
        Place Order
      </button>
    </mat-card-content>
  </mat-card>
</div>
