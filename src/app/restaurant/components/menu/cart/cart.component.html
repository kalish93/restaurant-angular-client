<div class="lg:col-span-1">
  <mat-card class="sticky xl:top-4 rounded-xl shadow-lg">
    <div class="bg-stone-600 text-white p-4 min-h-[50px] rounded-t-xl">

      <div class="flex items-center justify-between">
        <h3 class="!text-[16px] font-semibold text-white">Order Summary</h3>
        <span class="text-sm text-white/80">
          {{ getTotalItems() }} items
        </span>
      </div>
    </div>

    <mat-card-content class="p-4 space-y-4">
      <!-- Order Items -->
      <div class="space-y-3 pt-8">
        <div *ngFor="let item of cart; let i = index"
          class="group relative flex flex-col p-3 rounded-lg border border-orange-200 hover:border-orange-300 transition-colors duration-200"
          [class.expanding]="showInstructionsFor[item.menuItem.id]">

          <!-- Remove button (appears on hover) -->
          <button (click)="removeFromCart(item)" variant="icon"
            class="absolute top-[9px] right-2 text-gray-700 hover:text-red-500 transition-all duration-200 z-10"
            [attr.aria-label]="'Remove ' + item.menuItem.name">
            <mat-icon
              class="!text-base !w-[13px] !h-[13px] !text-xs rounded-full hover:bg-red-100 leading-none">close</mat-icon>
          </button>

          <!-- Item details and price -->
          <div class="flex justify-between items-start pr-8 mb-3">
            <div class="flex-1">
              <p class="text-sm font-medium text-gray-900">{{ item.menuItem.name }}</p>
              <p class="text-xs text-gray-700">£{{ item.menuItem.price.toFixed(2) }} each</p>
            </div>
            <div class="text-right">
              <p class="text-sm font-medium text-gray-900">
                ${{ (item.menuItem.price * item.quantity).toFixed(2) }}
              </p>
            </div>
          </div>

          <!-- Quantity controls -->
          <div class="flex items-center justify-between">
            <div class="flex items-center gap-2">
              <span class="text-xs text-gray-700">Qty:</span>
              <button (click)="updateQuantity(i, item.quantity - 1)" [disabled]="item.quantity <= 1"
                class="hover:text-orange-700 disabled:opacity-50 disabled:cursor-not-allowed text-gray-700 flex items-center justify-center"
                aria-label="Decrease quantity">
                <mat-icon
                  class="!w-[14px] !h-[14px] !text-xs rounded-full hover:bg-orange-100 leading-none">remove</mat-icon>
              </button>
              <span class="text-xs font-medium text-gray-900 min-w-[20px] text-center">
                {{ item.quantity }}
              </span>
              <button (click)="updateQuantity(i, item.quantity + 1)"
                class="hover:text-orange-700 text-gray-700 flex items-center justify-center"
                aria-label="Increase quantity">
                <mat-icon
                  class="!w-[14px] !h-[14px] !text-xs rounded-full hover:bg-orange-100 leading-none">add</mat-icon>
              </button>

            </div>
            <button (click)="toggleSpecialInstructions(item.menuItem.id)"
              class="text-xs text-orange-600 hover:text-orange-700 font-medium transition-colors flex items-center gap-1 mb-1">
              <mat-icon class="!text-xs !h-[14px] !w-[14px]">{{ showInstructionsFor[item.menuItem.id] ? 'remove' :
                (item.specialInstructions ? 'edit' : 'add') }}</mat-icon>
              {{ showInstructionsFor[item.menuItem.id] ? 'Remove' : (item.specialInstructions ? 'Edit' : 'Add') }}
              Special Instructions
            </button>
          </div>


          <div *ngIf="showInstructionsFor[item.menuItem.id]"
            class="special-instructions-container  rounded-lg transition-all duration-300 ease-in-out mb-2">
            <mat-form-field appearance="outline" class="w-full !h-[100px]">
              <mat-label>Special instructions</mat-label>
              <textarea matInput class="!h-[100px]" cdkTextareaAutosize cdkAutosizeMinRows="4"
                placeholder="e.g., No onions, extra spicy..." [value]="specialInstructions[item.menuItem.id] || ''"
                (input)="updateSpecialInstructions(item.menuItem.id, $any($event.target).value)"
                class="resize-none text-xs">
                  </textarea>
            </mat-form-field>
          </div>
          <div *ngIf="item.specialInstructions" class="mt-3 p-2 rounded-md bg-orange-50 border border-orange-200">
            <div class="flex items-center gap-2">
              <span class="text-xs font-medium text-orange-800 shrink-0">Note:</span>
              <p class="text-xs text-orange-700 leading-relaxed">
                {{ item.specialInstructions }}
              </p>
            </div>
          </div>
        </div>
      </div>

      <!-- Price Breakdown -->
      <div class="space-y-3 pt-4 border-t border-orange-200">
        <div class="flex justify-between text-sm pb-2 border-b border-orange-200">
          <span class="text-gray-700">Subtotal</span>
          <span class="font-medium text-gray-900">£{{ getSubtotal().toFixed(2) }}</span>
        </div>

        <!-- Tax breakdown for each item -->
        <div *ngFor="let taxItem of getTaxBreakdown()" class="flex justify-between text-sm">
          <span class="text-gray-700">{{ taxItem.itemName }} Tax ({{ taxItem.taxRate.toFixed(0) }}%)</span>
          <span class="font-medium text-gray-900">£{{ taxItem.taxAmount.toFixed(2) }}</span>
        </div>

        <!-- Total tax -->
        <div class="flex justify-between text-sm font-medium border-t border-gray-200 pt-2">
          <span class="text-gray-800">Total Tax</span>
          <span class="font-semibold text-gray-900">£{{ getTotalTax().toFixed(2) }}</span>
        </div>

        <div *ngIf="hasDiscount()" class="flex justify-between text-sm text-green-600">
          <span>Discount ({{ discountCode }})</span>
          <span>-£{{ getDiscountAmount().toFixed(2) }}</span>
        </div>
      </div>

      <div (click)="order()" class="bg-orange-400 hover:bg-orange-500 hover:cursor-pointer text-white p-4 rounded-lg">
        <div class="flex justify-between items-center">
          <span class="text-lg font-semibold">Total to pay</span>
          <span class="text-2xl font-bold">${{ getTotal().toFixed(2) }}</span>
        </div>
      </div>

      <button mat-flat-button
        class="w-full bg-green-600 hover:bg-green-700 text-white py-3 text-lg font-semibold rounded-lg"
        (click)="order()">
        Place Order
      </button>
    </mat-card-content>
  </mat-card>
</div>